<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>techdetails</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Type providers for SQL server access.">
    <meta name="author" content="Ross McKinlay, Colin Bull, Tuomas Hietanen">

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="../content/style.css" />
    <script type="text/javascript" src="../content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/fsprojects/SQLProvider">github page</a></li>
        </ul>
        <h3 class="muted"><a href="../index.html">SQLProvider</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          <h2><a name="Version-control-instructions" class="anchor" href="#Version-control-instructions">Version control instructions</a></h2>
<p>Git information is in a separate <a href="http://fsprojects.github.io/SQLProvider/core/contributing.html">document</a>.</p>
<h2><a name="The-environment" class="anchor" href="#The-environment">The environment</a></h2>
<p>Databases that you should need for development:</p>
<ul>
<li>Demo-data database scripts are at: <a href="https://github.com/fsprojects/SQLProvider/tree/master/src/DatabaseScripts">/src/DatabaseScripts/</a></li>
<li>Access database is at: <a href="https://github.com/fsprojects/SQLProvider/blob/master/docs/files/msaccess/Northwind.MDB">/docs/files/msaccess/Northwind.MDB</a></li>
<li>SQLite database is at: <a href="https://github.com/fsprojects/SQLProvider/blob/master/tests/SqlProvider.Tests/db/northwindEF.db">/tests/SqlProvider.Tests/db/northwindEF.db</a></li>
</ul>
<p>Even though our test run will run modifications to the test databases, don't check in these <code>*.mdb</code> and <code>*.db</code> files with your commit, to avoid bad merge-cases.</p>
<h3><a name="Solution-structure" class="anchor" href="#Solution-structure">Solution structure</a></h3>
<p>We use Fake and Paket. You have to run <code>build.cmd</code> on Windows (or <code>sh ./build.sh</code> on Mac/Linux) before opening the solutions.</p>
<p>The main source solution is <code>SQLProvider.sln</code>.
The unit tests are located in another one, <code>SQLProvider.Tests.sln</code>, and when you open the solution, it will lock the <code>bin\net451\FSharp.Data.SqlProvider.dll</code>, and after that you can't build the main solution.</p>
<ul>
<li>To debug design-time features you "Attach to process" the main solution debugger to another instance of Visual Studio running the tests solution.</li>
<li>To debug runtime you attach it to e.g. fsi.exe and run the code in interactive.</li>
</ul>
<h4><a name="Workarounds-for-file-in-use-issue-172" class="anchor" href="#Workarounds-for-file-in-use-issue-172">Workarounds for "file in use" (issue #172)</a></h4>
<ul>
<li>Debugging execution: Have all the test-files closed in your test-project when you open it with VS. Then you can run tests from the tests from Tests Explorer window (and even debug them if you open the files to that instance of VS from src\SqlProvider).</li>
<li>Or you can open tests with some other editor than Visual Studio 2015</li>
</ul>
<h3><a name="Referenced-Files" class="anchor" href="#Referenced-Files">Referenced Files</a></h3>
<ul>
<li>Documentation is located at <a href="https://github.com/fsprojects/SQLProvider/tree/master/docs/content/core">SQLProvider/docs/content/core</a> and it's converted directly to <code>*.html</code> help files by the build-script.</li>
<li><code>src/ProvidedTypes.fsi</code>, <code>src/ProvidedTypes.fs</code> and <code>src/Code/ExpressionOptimizer.fs</code> are coming from other repositoried restored by first build. Location is at <a href="https://github.com/fsprojects/SQLProvider/blob/master/paket.dependencies">packet.dependencies</a>. Don't edit them manually.</li>
</ul>
<h3><a name="Test-cases" class="anchor" href="#Test-cases">Test cases</a></h3>
<p>There are database specific test files as scripts in the test solution, <a href="https://github.com/fsprojects/SQLProvider/tree/master/tests/SqlProvider.Tests/scripts">/tests/SqlProvider.Tests/scripts/</a>, but also one generic <a href="https://github.com/fsprojects/SQLProvider/blob/master/tests/SqlProvider.Tests/QueryTests.fs">/tests/SqlProvider.Tests/QueryTests.fs</a> which is running all the SQLite tests in the build script.</p>
<h2><a name="High-level-description-of-the-provider" class="anchor" href="#High-level-description-of-the-provider">High level description of the provider</a></h2>
<h3><a name="Context-and-design-time" class="anchor" href="#Context-and-design-time">Context and design time</a></h3>
<p>You have a source code like:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="id">sql</span> <span class="o">=</span> <span class="id">SqlDataProvider</span><span class="o">&lt;...</span><span class="id">params</span><span class="pn">.</span><span class="o">..&gt;</span>
<span class="k">let</span> <span class="id">dc</span> <span class="o">=</span> <span class="id">sql</span><span class="pn">.</span><span class="id">GetDataContext</span><span class="pn">(</span><span class="pn">)</span>
</code></pre></td>
</tr>
</table>
<p>What will first happen in the design-time, is that this will call <code>createTypes</code> of <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlDesignTime.fs">SqlDesignTime.fs</a> and create (as lazily as possible) the database schema types (the shape of the database). These methods are added to the <code>sql.datacontext</code> and are stored to concurrent dictionaries. Visual Studio will do a lot of background processing so thread-safety is important here.</p>
<p><code>GetDataContext()</code> will return a dynamic class called dataContext which will on design-time call class SqlDataContext in file <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.DataContext.fs">SqlRuntime.DataContext.fs</a> through interface <code>ISqlDataContext</code>. SqlDataContext uses ProviderBuilder to create database specific providers, fairly well documented <code>ISqlProvider</code> in file <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.Common.fs">SqlRuntime.Common.fs</a>.</p>
<h3><a name="Querying" class="anchor" href="#Querying">Querying</a></h3>
<p>The entity-items themselves are rows in the database data and they are modelled as dynamic sub-classes of <code>SqlEntity</code>, base-class in file <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.Common.fs">SqlRuntime.Common.fs</a> which can be basically think of as wrapper for <code>Dictionary&lt;string,obj&gt;</code> (a column name, and the value). SqlEntity is used for all-kind of result-data actually, so the data columns may not correspond to the actual data values. Mostly the results of the data are shaped as <code>SqlQueryable&lt;SqlEntity&gt;</code>, or <code>SqlQueryable&lt;'T&gt;</code> which is a SQLProvider's class for <code>IQueryable&lt;'T&gt;</code> items.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="id">query</span> <span class="pn">{</span>
    <span class="k">for</span> <span class="id">cust</span> <span class="k">in</span> <span class="id">dbc</span><span class="pn">.</span><span class="id">Main</span><span class="pn">.</span><span class="id">Customers</span> <span class="k">do</span>
    <span class="id">where</span> <span class="pn">(</span><span class="s">&quot;ALFKI&quot;</span> <span class="o">=</span> <span class="id">cust</span><span class="pn">.</span><span class="id">CustomerId</span><span class="pn">)</span>
    <span class="id">select</span> <span class="id">cust</span>
<span class="pn">}</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="id">Seq</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="id">toArray</span>
</code></pre></td>
</tr>
</table>
<p>This query is translated to a LINQ-expression-tree through Microsoft.FSharp.Linq.QueryFSharpBuilder. That will call <code>IQueryable&lt;'T&gt;</code>'s member Provider to execute two things for the LINQ-expression-tree: first <code>CreateQuery</code> and later <code>Execute</code>.</p>
<h3><a name="Parsing-the-LINQ-expression-tree" class="anchor" href="#Parsing-the-LINQ-expression-tree">Parsing the LINQ-expression-tree</a></h3>
<p><code>CreateQuery</code> will hit our <code>SqlQueryable&lt;...&gt;</code>'s Provider (IQueryProvider) property. LINQ-expression-trees can be kind of recursive type structures, so we it will call CreateQuery for each linq-method. We get the expression-tree as parameter, and parse that with (multi-layer-) active patterns.</p>
<p>Our example the LINQ-expression tree is:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp">.Call System.Linq.Queryable.Where(
    .Constant&lt;System.Linq.IQueryable`<span class="n">1</span>[SqlEntity]<span class="o">&gt;</span>(SqlQueryable`<span class="n">1</span>[SqlEntity]),
    '(.Lambda #Lambda<span class="n">1</span>&lt;System.Func`<span class="n">2</span>[SqlEntity,Boolean]<span class="o">&gt;</span>))
.Lambda #Lambda<span class="n">1</span>&lt;System.Func`<span class="n">2</span>[SqlEntity,Boolean]<span class="o">&gt;</span>(SqlEntity $cust) {
    .Call $cust.GetColumn(<span class="s">"CustomerID"</span>) <span class="o">=</span><span class="o">=</span> <span class="s">"ALFKI"</span>
}
</code></pre></td></tr></table>
<p>so it would hit this in <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.Linq.fs">SqlRuntime.Linq.fs</a>:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="pn">|</span> <span class="id">MethodCall</span><span class="pn">(</span><span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="id">None</span><span class="pn">,</span> <span class="pn">(</span><span class="id">MethodWithName</span> <span class="s">&quot;Where&quot;</span> <span class="k">as</span> <span class="id">meth</span><span class="pn">)</span><span class="pn">,</span> <span class="pn">[</span> <span class="id">SourceWithQueryData</span> <span class="id">source</span><span class="pn">;</span> <span class="id">OptionalQuote</span> <span class="id">qual</span> <span class="pn">]</span><span class="pn">)</span> <span class="k">-&gt;</span>
</code></pre></td>
</tr>
</table>
<p>because the LINQ-expression-tree has <code>ExpressionType.Call</code> named "Where" with source of IWithSqlService (which is the SqlQueryable<SqlEntity>).
What happens then is parsing of the Where-query. Where-queries are nested structures having known conditions (modelled with pattern <code>Condition</code>). If the conditions are having <code>SqlColumnGet</code>s, a pattern that says that it's <code>SqlEntity</code> with method <code>GetColumn</code>, we know that it has to be part of SQL-clause.</p>
<p>We collect all the known patterns to <code>IWithSqlService</code>s field SqlExpression, being a type <code>SqlExp</code>, our non-complete known recursive model-tree of SQL clauses.</p>
<h3><a name="Execution-of-the-query" class="anchor" href="#Execution-of-the-query">Execution of the query</a></h3>
<p>Eventually there also comes the call <code>executeQuery</code> (or <code>executeQueryScalar</code> for SQL-queries that will return a single value like count), either by enumeration of our IQueryable or at the end of LINQ-expression-tree. That will call <code>QueryExpressionTransformer.convertExpression</code>. What happens there (in
<a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.Linq.fs">SqlRuntime.Linq.fs</a>):</p>
<ul>
<li>We create a projection-lambda. This is described in detail below.</li>
<li>We convert our <code>SqlExp</code> to real SQL-clause with <code>QueryExpressionTransformer.convertExpression</code> calling provider's <code>GenerateQueryText</code>-method. Each provider may have some differences in their SQL-syntax.</li>
<li>We gather the results as <code>IEnumerable&lt;SqlEntity&gt;</code> (or a single return value like count).</li>
<li>We execute the projection-lambda to the results.</li>
</ul>
<p>In our example the whole cust object was selected.
For security reasons we don't do <code>SELECT *</code> but we actually list the columns that are there at compile time.</p>
<p>The <code>TupleIndex</code> of IWithSqlService is a way to collect joined tables to match the sql-aliasses, here the <code>[cust]</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="sql"><span class="k">SELECT</span> [cust].[Address] <span class="k">as</span> <span class="s">'Address'</span>, 
       [cust].[City] <span class="k">as</span> <span class="s">'City'</span>,
       [cust].[CompanyName] <span class="k">as</span> <span class="s">'CompanyName'</span>,
     [cust].[ContactName] <span class="k">as</span> <span class="s">'ContactName'</span>,
     [cust].[ContactTitle] <span class="k">as</span> <span class="s">'ContactTitle'</span>,
     [cust].[Country] <span class="k">as</span> <span class="s">'Country'</span>,
     [cust].[CustomerID] <span class="k">as</span> <span class="s">'CustomerID'</span>,
     [cust].[Fax] <span class="k">as</span> <span class="s">'Fax'</span>,
     [cust].[Phone] <span class="k">as</span> <span class="s">'Phone'</span>,
     [cust].[PostalCode] <span class="k">as</span> <span class="s">'PostalCode'</span>,
     [cust].[Region] <span class="k">as</span> <span class="s">'Region'</span> 
<span class="k">FROM</span> main.Customers <span class="k">as</span> [cust] 
<span class="k">WHERE</span> (([cust].[CustomerID]= @param<span class="n">1</span>))

<span class="c">-- params @param1 - "ALFKI";</span>
</code></pre></td></tr></table>
<h3><a name="Projection-lambda" class="anchor" href="#Projection-lambda">Projection-lambda</a></h3>
<p>Now, if the select-clause would have been complex:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs1', 5)" onmouseover="showTip(event, 'fs1', 5)" class="id">query</span> <span class="pn">{</span>
    <span class="k">for</span> <span class="id">emp</span> <span class="k">in</span> <span class="id">dc</span><span class="pn">.</span><span class="id">Main</span><span class="pn">.</span><span class="id">Employees</span> <span class="k">do</span>
    <span class="id">select</span> <span class="pn">(</span><span class="id">emp</span><span class="pn">.</span><span class="id">BirthDate</span><span class="pn">.</span><span class="id">DayOfYear</span> <span class="o">+</span> <span class="n">3</span><span class="pn">)</span>
<span class="pn">}</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs2', 6)" onmouseover="showTip(event, 'fs2', 6)" class="id">Seq</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs3', 7)" onmouseover="showTip(event, 'fs3', 7)" class="id">toArray</span>
</code></pre></td>
</tr>
</table>
<p>We don't know the function of DayOfYear for each different SQL-providers (Oracle/MSSQL/Odbc/...), but we still want tihs code to work. The LINQ-expression-tree for this query is:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="csharp">.Call System.Linq.Queryable.Select(
    .Constant&lt;System.Linq.IQueryable`<span class="n">1</span>[SqlEntity]<span class="o">&gt;</span>(SqlQueryable`<span class="n">1</span>[SqlEntity]),
    '(.Lambda #Lambda<span class="n">1</span>&lt;System.Func`<span class="n">2</span>[SqlEntity,Int<span class="n">32</span>]<span class="o">&gt;</span>))
.Lambda #Lambda<span class="n">1</span>&lt;System.Func`<span class="n">2</span>[SqlEntity,System.Int<span class="n">32</span>]<span class="o">&gt;</span>(SqlEntity $emp) {
    (.Call $emp.GetColumn(<span class="s">"BirthDate"</span>)).DayOfYear <span class="o">+</span> <span class="n">3</span>
}
</code></pre></td></tr></table>
<p>What happens now, is that in <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.QueryExpression.fs">SqlRuntime.QueryExpression.fs</a> we parse the whole LINQ-expression-tree, and find the parts that we do know to belong to SQL:
the SqlEntity's <code>emp.GetColumn("BirthDate")</code>, and create a lambda-expression where this is replaced with a parameter:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">fun</span> <span class="id">empBirthDate</span> <span class="k">-&gt;</span> <span class="id">empBirthDate</span><span class="pn">.</span><span class="id">DayOfYear</span> <span class="o">+</span> <span class="n">3</span>
</code></pre></td>
</tr>
</table>
<p>Now when we get the empBirthDate from the SQL result, we can execute this lambda for the parameter, in .NET-side, not SQL, and then we get the correct result. This is done with <code>for e in results -&gt; projector.DynamicInvoke(e)</code> in <a href="https://github.com/fsprojects/SQLProvider/blob/master/src/SQLProvider/SqlRuntime.Linq.fs">SqlRuntime.Linq.fs</a>.</p>
<h3><a name="Other-things-to-know" class="anchor" href="#Other-things-to-know">Other things to know</a></h3>
<ul>
<li>SQLProvider also runs ExpressionOptimizer functions to simplify the LINQ-expression-trees</li>
<li>
<p>If you do IN-query (LINQ-Contains) to IEnumerable, it's as normal IN-query, but if the source collection is SqlQueryable<SqlEntity>, then the query is serialized as a nested query, where we have to check that the parameter names won't collide (i.e. param1 can be used only once).</p>
<p>This documentation was written on 2017-04-11.</p>
</li>
</ul>

<div class="tip" id="fs1">val query : Linq.QueryBuilder</div>
<div class="tip" id="fs2">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs3">val toArray : source:seq&lt;&#39;T&gt; -&gt; &#39;T []</div>
<div class="tip" id="fs4">union case Option.None: Option&lt;&#39;T&gt;</div>

        </div>
        <div class="span3">
          <ul class="nav nav-list" id="menu">
            <li class="nav-header">SQLProvider</li>
            <li><a href="../index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/SQLProvider">Get Library via NuGet</a></li>
            <li><a href="http://github.com/fsprojects/SQLProvider">Source Code on GitHub</a></li>
            <li><a href="http://github.com/fsprojects/SQLProvider/blob/master/LICENSE.txt">License</a></li>
            <li><a href="http://github.com/fsprojects/SQLProvider/blob/master/RELEASE_NOTES.md">Release Notes</a></li>
            
        
            <li class="nav-header">Documentation</li>
              <li><a href="../core/general.html">General</a></li>
              <li><a href="../core/parameters.html">Static Parameters</a></li>
              <li><a href="../core/querying.html">Querying</a></li>
              <li><a href="../core/constraints-relationships.html">Constraints & Relationships</a></li>
              <li><a href="../core/crud.html">CRUD</a></li>
              <li><a href="../core/programmability.html">Programmability</a></li>
              <li><a href="../core/individuals.html">Individuals</a></li>
              <li><a href="../core/composable.html">Composable Query</a></li>
              <li><a href="../core/mssql.html">SQL Server</a></li>
              <li><a href="../core/oracle.html">Oracle</a></li>
              <li><a href="../core/sqlite.html">SQLite</a></li>
              <li><a href="../core/postgresql.html">PostgreSQL</a></li>
              <li><a href="../core/mysql.html">MySQL</a></li>
              <li><a href="../core/odbc.html">ODBC</a></li>
              <li><a href="../reference/index.html">Internal API Docs</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/fsprojects/SQLProvider"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
  </html>
